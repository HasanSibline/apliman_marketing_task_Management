// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  SUPER_ADMIN    // System administrator - manages all companies
  COMPANY_ADMIN  // Company administrator - manages their company
  ADMIN          // Department admin
  EMPLOYEE       // Regular user
}

enum UserStatus {
  ACTIVE
  AWAY
  OFFLINE
  RETIRED
}

enum TaskPhase {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

// Multi-Tenancy: Company/Tenant model
model Company {
  id            String   @id @default(uuid())
  name          String   @unique
  slug          String   @unique // URL-friendly name
  logo          String? // Base64 or URL
  primaryColor  String   @default("#3B82F6")
  isActive      Boolean  @default(true)
  
  // Subscription
  subscriptionPlan     String   @default("FREE") // FREE, PRO, ENTERPRISE
  subscriptionStatus   String   @default("ACTIVE") // ACTIVE, TRIAL, EXPIRED, SUSPENDED
  subscriptionStart    DateTime @default(now())
  subscriptionEnd      DateTime?
  monthlyPrice         Float    @default(0)
  
  // AI Configuration - Each company has their own AI key
  aiApiKey             String? // Encrypted API key for AI services
  aiProvider           String   @default("gemini") // gemini, openai, etc.
  aiEnabled            Boolean  @default(false) // Controlled by having API key
  
  // Resource Limits
  maxUsers      Int      @default(10)
  maxTasks      Int      @default(1000)
  maxStorage    Int      @default(5) // GB
  
  // Billing
  billingEmail  String?
  billingAddress String?
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String? // Super admin ID who created it
  
  // Relations
  users         User[]
  tasks         Task[]
  workflows     Workflow[]
  settings      CompanySettings?
  subscriptionHistory SubscriptionHistory[]
  chatSessions  ChatSession[]
  knowledgeSources KnowledgeSource[]
  aiUsageStats  CompanyAIUsage[]
  
  @@map("companies")
}

// Company-specific settings
model CompanySettings {
  id                String  @id @default(uuid())
  companyId         String  @unique
  company           Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  // Branding
  secondaryColor    String  @default("#6B7280")
  accentColor       String  @default("#10B981")
  customDomain      String?
  favicon           String?
  
  // Features
  analyticsEnabled  Boolean @default(true)
  chatEnabled       Boolean @default(true)
  apiAccess         Boolean @default(false)
  
  // Localization
  timezone          String  @default("UTC")
  dateFormat        String  @default("MM/DD/YYYY")
  language          String  @default("en")
  
  // Notifications
  emailNotifications Boolean @default(true)
  webhookUrl         String?
  
  @@map("company_settings")
}

// Track subscription changes and history
model SubscriptionHistory {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  action      String // CREATED, UPGRADED, DOWNGRADED, RENEWED, SUSPENDED, EXPIRED, REACTIVATED
  fromPlan    String?
  toPlan      String
  amount      Float?
  reason      String?
  performedBy String // Super admin ID
  
  createdAt   DateTime @default(now())
  
  @@map("subscription_history")
}

// Track AI usage per company for billing/analytics
model CompanyAIUsage {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  date        DateTime @default(now()) // Daily tracking
  messageCount Int     @default(0) // Number of AI messages
  tokensUsed  Int      @default(0) // API tokens consumed
  cost        Float    @default(0) // Estimated cost
  
  @@unique([companyId, date])
  @@map("company_ai_usage")
}

model User {
  id           String     @id @default(uuid())
  companyId    String?    // NULL for SUPER_ADMIN, required for others
  company      Company?   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  email        String
  name         String
  password     String
  role         UserRole   @default(EMPLOYEE)
  position     String?
  department   String?
  status       UserStatus @default(OFFLINE)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  lastActiveAt DateTime?

  // Relations
  createdTasks       Task[]            @relation("TaskCreator")
  assignedTasks      Task[]            @relation("TaskAssignee")
  taskAssignments    TaskAssignment[]  @relation("TaskAssignments")
  assignedByMe       TaskAssignment[]  @relation("TaskAssigner")
  taskComments       TaskComment[]
  notifications      Notification[]
  createdWorkflows   Workflow[]        @relation("WorkflowCreator")
  assignedSubtasks   Subtask[]
  phaseHistory       PhaseHistory[]
  approvalsRequested PhaseApproval[]   @relation("ApprovalRequester")
  approvalsReviewed  PhaseApproval[]   @relation("ApprovalReviewer")
  knowledgeSources   KnowledgeSource[] @relation("KnowledgeSourceCreator")
  chatSessions       ChatSession[]
  chatContext        UserChatContext?

  // Email must be unique within a company (allow same email across companies)
  @@unique([email, companyId])
  @@map("users")
}

model Task {
  id             String    @id @default(uuid())
  companyId      String
  company        Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  title          String
  description    String
  taskType       String?
  workflowId     String?
  currentPhaseId String?
  phase          TaskPhase @default(PENDING_APPROVAL) // Keep for backward compatibility
  goals          String?
  priority       Int       @default(1) // 1-5 scale
  dueDate        DateTime?
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Foreign Keys
  assignedToId String? // Keep for backward compatibility
  createdById  String

  // Parent-child task relationships
  parentTaskId String?
  subtaskId    String? @unique

  // Relations
  assignedTo    User?            @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdBy     User             @relation("TaskCreator", fields: [createdById], references: [id])
  workflow      Workflow?        @relation(fields: [workflowId], references: [id])
  currentPhase  Phase?           @relation(fields: [currentPhaseId], references: [id])
  parentTask    Task?            @relation("ParentChildTasks", fields: [parentTaskId], references: [id])
  childTasks    Task[]           @relation("ParentChildTasks")
  linkedSubtask Subtask?         @relation("TaskSubtaskLink", fields: [subtaskId], references: [id])
  assignments   TaskAssignment[]
  files         TaskFile[]
  comments      TaskComment[]
  notifications Notification[]
  subtasks      Subtask[]
  phaseHistory  PhaseHistory[]
  approvals     PhaseApproval[]

  @@map("tasks")
}

model TaskAssignment {
  id           String   @id @default(uuid())
  taskId       String
  userId       String
  assignedAt   DateTime @default(now())
  assignedById String? // Who assigned this user to the task

  // Relations
  task       Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user       User  @relation("TaskAssignments", fields: [userId], references: [id], onDelete: Cascade)
  assignedBy User? @relation("TaskAssigner", fields: [assignedById], references: [id])

  @@unique([taskId, userId])
  @@map("task_assignments")
}

model TaskFile {
  id         String   @id @default(uuid())
  taskId     String
  fileName   String
  filePath   String
  fileType   String
  fileSize   Int // Size in bytes after compression
  mimeType   String
  uploadedAt DateTime @default(now())

  // Relations
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@map("task_files")
}

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  comment   String
  createdAt DateTime @default(now())

  // Relations
  task   Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user   User           @relation(fields: [userId], references: [id])
  images CommentImage[]

  @@map("task_comments")
}

model CommentImage {
  id        String   @id @default(uuid())
  commentId String
  data      String // Base64 encoded image data
  mimeType  String // e.g., "image/jpeg", "image/png"
  size      Int // Size in bytes
  createdAt DateTime @default(now())

  // Relations
  comment TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@map("comment_images")
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  taskId    String?
  subtaskId String?
  phaseId   String?
  type      String // 'task_created', 'task_assigned', 'task_updated', 'task_approved', 'task_rejected', 'task_completed', 'phase_changed', 'subtask_assigned'
  title     String
  message   String
  actionUrl String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  task    Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  subtask Subtask? @relation(fields: [subtaskId], references: [id], onDelete: Cascade)
  phase   Phase?   @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Workflow {
  id          String   @id @default(uuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  taskType    String
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  color       String   @default("#3B82F6")
  icon        String?
  createdById String
  createdBy   User     @relation("WorkflowCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  phases Phase[]
  tasks  Task[]

  // Unique name per company
  @@unique([name, companyId])
  @@map("workflows")
}

model Phase {
  id         String   @id @default(uuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  name        String
  description String?
  order       Int
  color       String  @default("#6B7280")

  allowedRoles     String[] @default([]) // DEPRECATED: Use allowedUsers instead
  allowedUsers     String[] @default([]) // User IDs who can access this phase
  autoAssignRole   String? // DEPRECATED: Use autoAssignUserId instead
  autoAssignUserId String? // Specific user ID to auto-assign

  isStartPhase     Boolean @default(false)
  isEndPhase       Boolean @default(false)
  requiresApproval Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks           Task[]
  subtasks        Subtask[]
  transitionsFrom Transition[]    @relation("FromPhase")
  transitionsTo   Transition[]    @relation("ToPhase")
  notifications   Notification[]
  approvals       PhaseApproval[]

  @@unique([workflowId, order])
  @@map("phases")
}

model Transition {
  id          String @id @default(uuid())
  fromPhaseId String
  fromPhase   Phase  @relation("FromPhase", fields: [fromPhaseId], references: [id], onDelete: Cascade)
  toPhaseId   String
  toPhase     Phase  @relation("ToPhase", fields: [toPhaseId], references: [id], onDelete: Cascade)

  name        String?
  conditions  Json?
  notifyRoles String[] @default([]) // DEPRECATED: Use notifyUsers instead
  notifyUsers String[] @default([]) // User IDs to notify on transition

  createdAt DateTime @default(now())

  @@unique([fromPhaseId, toPhaseId])
  @@map("transitions")
}

model Subtask {
  id     String @id @default(uuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  title       String
  description String?
  order       Int

  phaseId String?
  phase   Phase?  @relation(fields: [phaseId], references: [id])

  assignedToId  String?
  assignedTo    User?   @relation(fields: [assignedToId], references: [id])
  suggestedRole String?

  isCompleted    Boolean   @default(false)
  completedAt    DateTime?
  dueDate        DateTime?
  estimatedHours Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  notifications Notification[]
  linkedTask    Task?          @relation("TaskSubtaskLink") // Individual task created for this subtask

  @@map("subtasks")
}

model PhaseHistory {
  id     String @id @default(uuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  fromPhaseId String?
  toPhaseId   String

  movedById String
  movedBy   User   @relation(fields: [movedById], references: [id])

  comment String?
  movedAt DateTime @default(now())

  @@map("phase_history")
}

model PhaseApproval {
  id     String @id @default(uuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  phaseId String
  phase   Phase  @relation(fields: [phaseId], references: [id])

  requestedById String
  requestedBy   User   @relation("ApprovalRequester", fields: [requestedById], references: [id])

  status String @default("PENDING") // PENDING, APPROVED, REJECTED

  reviewedById String?
  reviewedBy   User?   @relation("ApprovalReviewer", fields: [reviewedById], references: [id])

  reviewComment String?

  requestedAt DateTime  @default(now())
  reviewedAt  DateTime?

  @@map("phase_approvals")
}

model SystemSettings {
  id               String   @id @default(uuid())
  maxFileSize      Int      @default(5242880) // 5MB in bytes
  allowedFileTypes String   @default("image/jpeg,image/png,image/webp,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document")
  sessionTimeout   Int      @default(480) // 8 hours in minutes
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("system_settings")
}

enum KnowledgeSourceType {
  APLIMAN
  COMPETITOR
}

model KnowledgeSource {
  id            String              @id @default(uuid())
  companyId     String
  company       Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  name          String // Display name (e.g., "Apliman Main Site", "Competitor X")
  url           String // URL to scrape
  type          KnowledgeSourceType // APLIMAN or COMPETITOR
  description   String? // Optional description
  isActive      Boolean             @default(true) // Can be disabled without deletion
  content       String?             @db.Text // Extracted content from URL
  lastScraped   DateTime? // Last time content was fetched
  scrapingError String?             @db.Text // Last error if scraping failed
  metadata      Json? // Additional metadata (title, keywords, etc.)
  priority      Int                 @default(1) // For ordering sources (1-5)
  createdById   String
  createdBy     User                @relation("KnowledgeSourceCreator", fields: [createdById], references: [id])
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("knowledge_sources")
}

model ChatSession {
  id        String        @id @default(uuid())
  companyId String
  company   Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String        @default("New Chat") // Auto-generated or custom
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  endedAt   DateTime?
  messages  ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id        String      @id @default(uuid())
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role      String // "user" or "assistant"
  content   String      @db.Text
  metadata  Json? // For storing mentions, task references, etc.
  createdAt DateTime    @default(now())

  @@map("chat_messages")
}

model UserChatContext {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  context   Json // Stores learned information about the user (name, preferences, etc.)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_chat_contexts")
}
